# Init DB

CREATE DATABASE rscraper;

USE rscraper;


CREATE TABLE user (
    id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(128),
    created_at BIGINT UNSIGNED NOT NULL DEFAULT 0,
    PRIMARY KEY (id)
);

CREATE TABLE subreddit (
    id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(128),
    created_at BIGINT UNSIGNED NOT NULL DEFAULT 0,
    PRIMARY KEY (id)
);

CREATE TABLE submission (
    id BIGINT UNSIGNED NOT NULL,
    author_id BIGINT UNSIGNED NOT NULL DEFAULT 0,
    subreddit_id BIGINT UNSIGNED NOT NULL,
    content VARCHAR(40000),
    created_at BIGINT UNSIGNED NOT NULL DEFAULT 0,
    PRIMARY KEY (id)
);

CREATE TABLE comment (
    id BIGINT UNSIGNED NOT NULL,
    parent_id BIGINT UNSIGNED NOT NULL DEFAULT 0,
    author_id BIGINT UNSIGNED NOT NULL,
    submission_id BIGINT UNSIGNED NOT NULL,
    content VARCHAR(40000) NOT NULL,
    created_at BIGINT UNSIGNED NOT NULL,
    reason_matched INT UNSIGNED NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE subreddit2tag (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    subreddit_id BIGINT UNSIGNED NOT NULL,
    tag_id BIGINT UNSIGNED NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE tag (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(128) UNIQUE,
    PRIMARY KEY (id)
);

CREATE TABLE reason_matched (
    id INT UNSIGNED NOT NULL,
    name UNIQUE VARCHAR(128),
    PRIMARY KEY (id)
);

CREATE TABLE user2subreddit_cmnt_count (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,
    subreddit_id BIGINT UNSIGNED NOT NULL,
    count INT UNSIGNED NOT NULL,
    UNIQUE KEY `user2subreddit` (`user_id`, `subreddit_id`),
    PRIMARY KEY (id)
);



# Grant Permissions

CREATE USER 'rscraper++'@'localhost' IDENTIFIED BY '[PASSWORD]';

GRANT SELECT, INSERT ON rscraper.* TO 'rscraper++'@'localhost';








# Tag subreddit SUBREDDIT_NAME with tag TAG_NAME (assuming TAG_NAME exists in tag table)

INSERT INTO subreddit2tag (tag_id, subreddit_id)
SELECT t.id, s.id
FROM tag t JOIN subreddit s
WHERE (t.name = 'TAG_NAME') AND (s.name = 'SUBREDDIT_NAME')
;



# Print table of subreddit, username, comment

SELECT r.name AS 'subreddit', R.name AS 'user', R.content
FROM subreddit r
JOIN (
    SELECT s.subreddit_id, P.name, P.content
    FROM submission s
    JOIN (
        SELECT u.name, T.content, T.submission_id
        FROM user u
        JOIN (
            SELECT c.author_id, c.content, c.submission_id
            FROM comment c
        ) T ON T.author_id = u.id
    ) P on P.submission_id = s.id
) R on R.subreddit_id = r.id
;



# Print table of submissions in subreddits tagged with TAG

SELECT R.name, s.id
FROM submission s
JOIN (
    SELECT r.id, r.name
    FROM subreddit r
    JOIN (
        SELECT s2t.subreddit_id
        FROM subreddit2tag s2t
        JOIN (
            SELECT t.id
            FROM tag t
            WHERE t.name = 'TAG'
        ) T on T.id = s2t.tag_id
    ) S2T on S2T.subreddit_id = r.id
) R on R.id = s.subreddit_id
;


# Print table of subreddit, username, comment in subreddits tagged with TAG

SELECT C.name, u.name, C.content
FROM user u
JOIN (
    SELECT S.name, c.author_id, c.content
    FROM comment c
    JOIN (
        SELECT R.name, s.id
        FROM submission s
        JOIN (
            SELECT r.id, r.name
            FROM subreddit r
            JOIN (
                SELECT s2t.subreddit_id
                FROM subreddit2tag s2t
                JOIN (
                    SELECT t.id
                    FROM tag t
                    WHERE t.name = 'TAG'
                ) T on T.id = s2t.tag_id
            ) S2T on S2T.subreddit_id = r.id
        ) R on R.id = s.subreddit_id
    ) S on S.id = c.submission_id
) C on C.author_id = u.id
;


# Print table of permalink, comment in subreddits tagged with TAG1 or TAG2

SELECT CONCAT("https://www.reddit.com/r/", S.name, "/comments/"), c.id, c.content
FROM comment c
JOIN (
    SELECT R.name, s.id
    FROM submission s
    JOIN (
        SELECT r.id, r.name
        FROM subreddit r
        JOIN (
            SELECT s2t.subreddit_id
            FROM subreddit2tag s2t
            JOIN (
                SELECT t.id
                FROM tag t
                WHERE t.name IN ('TAG1','TAG2')
            ) T on T.id = s2t.tag_id
        ) S2T on S2T.subreddit_id = r.id
    ) R on R.id = s.subreddit_id
) S on S.id = c.submission_id
;



















# Print table of subreddit, username, comment, reason_matched

SELECT R.reason, r.name AS 'subreddit', R.name AS 'user', R.content
FROM subreddit r
JOIN (
    SELECT s.subreddit_id, P.name, P.content, P.reason
    FROM submission s
    JOIN (
        SELECT u.name, T.content, T.submission_id, T.reason
        FROM user u
        JOIN (
            SELECT c.author_id, c.content, c.submission_id, RAISON.name as reason
            FROM comment c
            JOIN (
                SELECT id, name
                FROM reason_matched
            ) RAISON ON RAISON.id = c.reason_matched
        ) T ON T.author_id = u.id
    ) P on P.submission_id = s.id
) R on R.subreddit_id = r.id
;


# Print table of subreddit, username, comment, reason_matched for a list of users

SELECT R.reason, r.name AS 'subreddit', R.name AS 'user', R.content
FROM subreddit r
JOIN (
    SELECT s.subreddit_id, P.name, P.content, P.reason
    FROM submission s
    JOIN (
        SELECT u.name, T.content, T.submission_id, T.reason
        FROM user u
        JOIN (
            SELECT c.author_id, c.content, c.submission_id, RAISON.name as reason
            FROM comment c
            JOIN (
                SELECT id, name
                FROM reason_matched
            ) RAISON ON RAISON.id = c.reason_matched
        ) T ON T.author_id = u.id
        WHERE u.name IN ('USERNAME1','USERNAME2')
    ) P on P.submission_id = s.id
) R on R.subreddit_id = r.id
;






# Print table of tagged subreddits and their tags, sorted by tag name

SELECT s.name, B.name as 'tag'
FROM subreddit s
JOIN (
    SELECT A.subreddit_id, t.name
    FROM tag t
    JOIN (
        SELECT s2t.subreddit_id, s2t.tag_id
        FROM subreddit2tag s2t
    ) A ON A.tag_id = t.id
) B ON B.subreddit_id = s.id
ORDER BY tag
;


# Print table of untagged subreddits

SELECT s.name as 'tag'
FROM subreddit s
WHERE s.id NOT IN (
    SELECT A.subreddit_id
    FROM tag t
    JOIN (
        SELECT s2t.subreddit_id, s2t.tag_id
        FROM subreddit2tag s2t
    ) A ON A.tag_id = t.id
)
ORDER BY s.name
;


# Sort the most commented-in subreddit_ids

SELECT SUM(count), subreddit_id
FROM user2subreddit_cmnt_count
GROUP BY subreddit_id
ORDER BY SUM(count)
;

# Sort the most commented-in subreddits

SELECT r.name, r.id, C.c
FROM subreddit r
JOIN (
    SELECT SUM(count) as c, subreddit_id
    FROM user2subreddit_cmnt_count
    GROUP BY subreddit_id
) C ON C.subreddit_id = r.id
ORDER BY C.c
;


# List comments per subreddit for list of usernames

SELECT UU.user, s.name as 'subreddit', UU.count
FROM subreddit s
JOIN (
    SELECT U.name as 'user', u2scc.subreddit_id, u2scc.count
    FROM user2subreddit_cmnt_count u2scc
    JOIN (
        SELECT u.name, u.id
        FROM user u
        # WHERE u.name IN ('USERNAME1','USERNAME2')
    ) U ON U.id = u2scc.user_id
) UU ON UU.subreddit_id = s.id
;

